---
title: "DATS 6101 Project 2"
author: "Syed Ibrahim Hamza, Pratik Shetty, and Dominique Howell"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float:
      collapsed: true
      smooth_scroll: true
    number_sections: true
    theme: united
    code_folding: hide
---

```{css, echo=FALSE}
/* Font adjustments */
body { font-size: 14px; line-height: 1.5; }
h1 { font-size: 26px; }
h2 { font-size: 20px; }
h3 { font-size: 18px; }
.tocify-content { font-size: 14px !important; }
```

```{r setup, message=FALSE, warning=FALSE, echo=FALSE}
library(tidyverse)
library(lattice)
library(corrplot)
library(car)
library(caret)
library(leaps)
library(pROC)
library(pscl)
library(rpart)
library(rpart.plot)
library(randomForest)
library(glmnet)
library(MASS)
library(ezids)
library(kableExtra)

brfss = readRDS("../Data/Processed/brfss_2018_2023.rds")
```

# Introduction

## Project Overview
This project **builds upon the exploratory and descriptive analysis** conducted in **Project 1**, which examined changes in **obesity prevalence** and **lifestyle behaviors** among U.S. adults **before and after the onset of COVID-19** using **BRFSS data (2018–2023)**.

Moving beyond **trend analysis**, **Project 2** focuses on **statistical modeling and prediction** to better understand the factors associated with **obesity** and **BMI** in the **post-COVID period**.

Using **nationally representative BRFSS data**, we develop **predictive and inferential models** to assess how **demographic**, **behavioral**, and **temporal factors** relate to obesity outcomes.

In particular, we examine the roles of **physical activity**, **alcohol use**, and **mental health**, while controlling for key **sociodemographic covariates**.

These models aim to provide **rigorous, data-driven insights** into **obesity risk** and its **behavioral correlates** following the **COVID-19 pandemic**.


## Data Sources
- **Raw data**: stored in `Data/Raw/`, obtained from the [CDC BRFSS Annual Data Portal](https://www.cdc.gov/brfss/annual_data/annual_data.htm).  
- **Processed data**: cleaned and merged dataset saved in `Data/Processed/`.  
- **Final analytical dataset**: `Data/Processed/brfss_2018_2023.rds` (over 100k observations, ~24 variables).  

# Question # 1
<br>
Obesity is a major public health concern in the United States and is associated with numerous chronic health conditions.
Using Behavioral Risk Factor Surveillance System (BRFSS) data from 2020–2023, this study examines whether demographic and lifestyle characteristics can be used to predict adult obesity status.

Research Question:

Can we predict the likelihood of an adult being obese (BMI ≥ 30) based on demographic and lifestyle factors such as age, sex, race/ethnicity, income category, physical activity, and alcohol consumption?
<br>

## Data Preparation & Variable Selection
<br>
Body Mass Index (BMI) was used to define obesity status following CDC guidelines. A binary obesity indicator was created where individuals with a BMI of 30 or higher were classified as obese, and those with a BMI below 30 were classified as non-obese. This outcome variable was represented both as a numeric indicator (0/1) for modeling purposes and as a factor variable to support classification-based methods.
<br>

```{r, message=FALSE, warning=FALSE}
brfss = readRDS('../Data/Processed/brfss_2018_2023.rds')

brfss_postcovid <- subset(brfss, interview_year >= 2020)

brfss_postcovid <- brfss_postcovid %>%
  mutate(
    obese_num = ifelse(bmi >= 30, 1, 0),
    obese = factor(obese_num, labels = c("No", "Yes"))
  )
```

<br>
Variables were selected based on prior public health literature and their theoretical relevance to obesity risk. The final analytic dataset includes demographic characteristics, lifestyle behaviors, and temporal indicators that may influence obesity outcomes.
<br>

```{r, message=FALSE, warning=FALSE}
vars <- brfss_postcovid %>%
  dplyr::select(obese, obese_num, bmi, age, sex, race_ethnicity, income_category,
                any_exercise_last_month, binge_drinking,
                max_drinks_30day, interview_year)

glimpse(vars)
```

## EDA
```{r, message=FALSE, warning=FALSE}
numeric_vars <- vars %>% 
  dplyr::select(age, bmi, max_drinks_30day, interview_year)

spearman_corr <- cor(numeric_vars, use = "complete.obs", method = "spearman")

corrplot(spearman_corr, method = "color", type = "upper")
```
<br>
The Spearman correlation matrix indicates very weak monotonic relationships among the numerical variables, with the strongest relationships being a weak negative correlation between age and max_drinks_30day (more alcohol consumed in one sitting is associated with younger age) and a weak positive correlation between age and bmi.
<br>

```{r, message=FALSE, warning=FALSE}
densityplot(~ bmi | obese, data = vars)
```
<br>
This density plot shows the distribution of BMI for the non-obese ("No") and obese ("Yes") classes. The plot visually confirms that while the distributions are distinctly centered below and above the BMI 30 cutoff, the long, thin tail on the "Yes" side extends to very high BMI values (80+) and overlaps slightly with the "No" class near the boundary.
<br>

```{r, message=FALSE, warning=FALSE}
bwplot(bmi ~ income_category, data = vars)
```
<br>
This boxplot illustrates the distribution of BMI across Income Categories. The chart shows that the median BMI is nearly constant across all five income brackets, but all categories contain extreme outliers, indicating high-BMI individuals exist across the entire socioeconomic spectrum.
<br>

```{r, message=FALSE, warning=FALSE}
xyplot(bmi ~ age, groups = obese, data = vars,
       auto.key = TRUE, type = c("p", "r"))
```
<br>
This scatterplot, showing BMI vs. Age, visually demonstrates the difficulty of the classification task. The two classes ("No" in blue, "Yes" in orange) show significant vertical overlap, especially in middle age, meaning a person's age provides little clean separation for predicting their obesity status.
<br>

```{r, message=FALSE, warning=FALSE}
lm_temp <- lm(bmi ~ age + sex + race_ethnicity + income_category +
                any_exercise_last_month + binge_drinking +
                max_drinks_30day + interview_year,
              data = vars)

xkabledply(vif(lm_temp))
```
<br>
The key finding is that all GVIF (Generalized VIF) values are very close to 1.0 (with the highest being 1.17 for max_drinks_30day). This confirms that there is no significant multicollinearity among your set of predictors, meaning that each variable contributes unique information to the model and their effects can be reliably separated.
<br>

## Modeling Approach

### Train–Test Split
```{r, message=FALSE, warning=FALSE}
set.seed(123)
train_index <- createDataPartition(vars$obese, p = 0.7, list = FALSE)
train <- vars[train_index, ]
test  <- vars[-train_index, ]
```
<br>
The dataset was randomly divided into training (70%) and testing (30%) sets using stratified sampling to preserve the distribution of obesity status. The training set was used for model development, while the testing set was reserved for performance evaluation.
<br>

### Feature Engineering
```{r, message=FALSE, warning=FALSE}
X_train <- model.matrix(obese ~ age + sex + race_ethnicity + income_category +
                          any_exercise_last_month + binge_drinking +
                          max_drinks_30day + interview_year,
                        data = train)[, -1]

X_test <- model.matrix(obese ~ age + sex + race_ethnicity + income_category +
                         any_exercise_last_month + binge_drinking +
                         max_drinks_30day + interview_year,
                       data = test)[, -1]
```
<br>
Categorical predictors were converted to numeric format using one-hot encoding to support regression and regularization methods. Feature matrices for the training and testing sets were aligned and cleaned to ensure consistent predictor structures across all models.
<br>

### Baseline Model: Logistic Regression
```{r, message=FALSE, warning=FALSE}
glm_baseline <- glm(
  obese ~ age + sex + race_ethnicity + income_category +
    any_exercise_last_month + binge_drinking +
    max_drinks_30day + interview_year,
  data = train,
  family = binomial
)

xkabledply(summary(glm_baseline))
```
<br>
This logistic regression summary shows that nearly all predictors are statistically significant (many at $p < 0.0001$), with lack of exercise (coefficient 0.5918), Black NH race (coefficient 0.5868), age (coefficient 0.0110), and max drinks (coefficient 0.0546) having the strongest positive association with the log-odds of being obese. The model suggests that the probability of obesity increases with age, max drinks consumed, being in certain minority groups, and not exercising.
<br>

### Best Subset Selection
```{r, message=FALSE, warning=FALSE}
regfit_bmi <- regsubsets(
  bmi ~ age + sex + race_ethnicity + income_category +
    any_exercise_last_month + binge_drinking +
    max_drinks_30day + interview_year,
  data = train,
  nvmax = 10
)

summary(regfit_bmi)
```
<br>
This exhaustive selection process for predicting continuous BMI shows that 'any_exercise_last_monthNo' is the single best predictor, followed by age, and then max_drinks_30day and 'race_ethnicityBlack NH'. The model requires at least 8 to 10 variables to reach the highest Adjusted $R^2$ (as seen in regsubsets_Q1.png which shows the included variables), confirming that many factors are needed but their combined linear effect on BMI is inherently weak.
<br>

### LASSO Logistic Regression
```{r, message=FALSE, warning=FALSE}
X_train_mat <- as.matrix(X_train)
y_train <- ifelse(train$obese == "Yes", 1, 0)

set.seed(123)
cvfit <- cv.glmnet(X_train_mat, y_train, family = "binomial", alpha = 1)

plot(cvfit)
```
<br>
Using cross-validation, LASSO was implemented to find the optimal penalty ($\lambda$) that minimizes out-of-sample error, resulting in a slightly higher AUC (0.596) than the standard Logistic Regression (0.595).  This process retains the strongest predictors while shrinking the coefficients of less relevant variables toward zero, improving model generalization.
<br>

### Classification Tree
```{r, message=FALSE, warning=FALSE}
tree_model <- rpart(
  obese ~ age + sex + race_ethnicity + income_category +
    any_exercise_last_month + binge_drinking +
    max_drinks_30day + interview_year,
  data = train,
  method = "class"
)

pred_tree_prob <- predict(tree_model, newdata = test, type = "prob")[, "Yes"]
pred_tree_class <- factor(ifelse(pred_tree_prob > 0.5, "Yes", "No"), levels = c("No","Yes"))
conf_mat_tree <- confusionMatrix(pred_tree_class, test$obese, positive = "Yes")
print(conf_mat_tree)
roc_tree <- roc(response = test$obese, predictor = pred_tree_prob, levels = c("No","Yes"))
print(auc(roc_tree))
```
<br>
The Classification Tree model developed using rpart is highly interpretable, explicitly showing that the primary split for predicting obesity is based on 'any_exercise_last_month', followed by age. The tree achieved the lowest AUC (0.543) of all models, indicating that its simple, sequential decision logic sacrifices predictive accuracy for interpretability.
<br>

### Random Forest
```{r, message=FALSE, warning=FALSE}
set.seed(123)
rf_model <- randomForest(
  obese ~ age + sex + race_ethnicity + income_category +
    any_exercise_last_month + binge_drinking +
    max_drinks_30day + interview_year,
  data = train,
  ntree = 500,
  importance = TRUE
)

xkabledply(varImpPlot(rf_model))

pred_rf_prob <- predict(rf_model, newdata = test, type = "prob")[, "Yes"]
pred_rf_class <- predict(rf_model, newdata = test, type = "response")
conf_mat_rf <- confusionMatrix(pred_rf_class, test$obese, positive = "Yes")
print(conf_mat_rf)
roc_rf <- roc(response = test$obese, predictor = pred_rf_prob, levels = c("No","Yes"))
print(auc(roc_rf))
```
<br>
This ensemble method generated 500 trees and yielded an AUC of 0.594, which is comparable to the linear models but superior in capturing non-linear effects. The Variable Importance plot confirms that 'any_exercise_last_month', 'max_drinks_30day', age, and 'race_ethnicity' are the most influential factors, showing the highest Mean Decrease Gini.
<br>

## Model Evaluation
```{r, message=FALSE, warning=FALSE}
roc_glm <- roc(test$obese, predict(glm_baseline, test, type = "response"))
roc_tree <- roc(test$obese, predict(tree_model, test, type = "prob")[, "Yes"])
roc_rf   <- roc(test$obese, predict(rf_model, test, type = "prob")[, "Yes"])

auc_table <- tibble(
  Model = c("Logistic Regression", "Classification Tree", "Random Forest"),
  AUC = c(auc(roc_glm), auc(roc_tree), auc(roc_rf))
)

xkabledply(auc_table)
```
<br>
This comparison demonstrates that tree-based ensemble methods, like Random Forest, and Logistic Regression achieved nearly identical predictive performance, hovering just under an AUC of 0.60. The Classification Tree, due to its simplicity, performed the worst with an AUC of 0.5000.
<br>

### Critical Limitations
Weak Predictive Power: The model's low AUC ($\approx 0.60$) and very low McFadden pseudo-$R^2$ ($\approx 0.02$) confirm that the tested variables have weak explanatory power over obesity status.

Imbalance/Bias: Models show extremely high Specificity ($\approx 0.98$) but fail to detect the obese class due to critically low Sensitivity ($\approx 0.03-0.05$), indicating severe class imbalance and a conservative prediction bias toward the majority "No" class.

Insufficient Features: The low predictive success suggests crucial drivers of obesity (e.g., genetics, detailed diet) are not captured by the current BRFSS demographic and lifestyle features.

### Recommendations for Future Work
Address Imbalance: Implement undersampling to balance the "No" and "Yes" classes to improve Sensitivity and reduce prediction bias.

Feature Augmentation: Introduce better features (e.g., specific diet indicators or local environmental data) to increase the model's overall signal.

Non-Linear Models: Test an SVM with a non-linear kernel to determine if a complex, curved boundary can better separate the overlapping data points.


# Question # 2
<br>
Physical activity is widely recognized as a key behavioral factor linked to weight outcomes and chronic disease risk. Using BRFSS data from **2018–2023**, this question evaluates how strongly physical activity is associated with **BMI** and whether the relationship remains after accounting for demographic and health covariates.

Research Question:

To what extent can physical activity level predict an individual’s BMI, while controlling for demographic covariates and survey year?
<br>

## Data Preparation & Variable Selection
<br>
We first restricted the dataset to the variables needed for BMI, physical activity, demographics, health status indicators, and survey year. Variables were recoded into appropriate factor formats and ordered where meaningful (e.g., interview year, BMI category, age group, education). We also created several binary indicators to support modeling: obesity status (`obese`), exercise (`exercise`), diabetes (`diabetes`), heart attack history (`heart_attack`), coronary heart disease history (`coronary`), stroke history (`stroke`), and self-reported health (`self_health`). These transformations ensure consistent interpretation across regression and classification analyses.
<br>

```{r, message=FALSE, warning=FALSE}
library(dplyr)
library(survey)
library(ggplot2)
library(tidyr)
library(ezids)
library(car)
library(pROC)
library(pscl)
library(corrplot)

brfss = readRDS("../Data/Processed/brfss_2018_2023.rds")

brfss_1 = brfss[,c(1:8,12:16,19:22,24)]

str(brfss_1)

brfss_1$psu = as.factor(brfss_1$psu)
brfss_1$psu <- factor(brfss_1$psu)

brfss_1$interview_year = as.factor(brfss_1$interview_year)
brfss_1$interview_year <- factor(brfss_1$interview_year, order=T,
levels = c("2018","2019","2020","2021","2022","2023"))

brfss_1$bmi_category = as.factor(brfss_1$bmi_category)
brfss_1$bmi_category <- factor(brfss_1$bmi_category, order=T,
levels = c("Underweight","Normal weight","Overweight","Obese"))

brfss_1$overweight_or_obese = as.factor(brfss_1$overweight_or_obese)
brfss_1$overweight_or_obese <- factor(brfss_1$overweight_or_obese, order=T,
levels = c("Yes","No"))

brfss_1$any_exercise_last_month = as.factor(brfss_1$any_exercise_last_month)
brfss_1$any_exercise_last_month <- factor(brfss_1$any_exercise_last_month, order=T,
levels = c("No","Yes"))

brfss_1$sex = as.factor(brfss_1$sex)
brfss_1$sex <- factor(brfss_1$sex, order=F)

brfss_1$age_group = as.factor(brfss_1$age_group)
brfss_1$age_group <- factor(brfss_1$age_group, order=T,
levels = c("18-24","25-29","30-34","35-39","40-44","45-49",
"50-54","55-59","60-64","65-69","70-74","75-79","80 or older"))

brfss_1$race_ethnicity = as.factor(brfss_1$race_ethnicity)
brfss_1$race_ethnicity <- factor(brfss_1$race_ethnicity, order=F)

brfss_1$education_level = as.factor(brfss_1$education_level)
brfss_1$education_level <- factor(brfss_1$education_level, order=T,
levels = c("No school/K","Grades 1-8","Grades 9-11",
"Grade 12/GED","College 1-3 years","College 4+ years"))

brfss_1$diabetes_status = as.factor(brfss_1$diabetes_status)
brfss_1$diabetes_status <- factor(brfss_1$diabetes_status, order=T,
levels = c("No","Yes","Pre-diabetes","Yes, only pregnancy"))

brfss_1$coronary_hd_history = as.factor(brfss_1$coronary_hd_history)
brfss_1$coronary_hd_history <- factor(brfss_1$coronary_hd_history, order=T,
levels = c("No","Yes"))

brfss_1$stroke_history = as.factor(brfss_1$stroke_history)
brfss_1$stroke_history <- factor(brfss_1$stroke_history, order=T,
levels = c("No","Yes"))

brfss_1$self_reported_health = as.factor(brfss_1$self_reported_health)
brfss_1$self_reported_health <- factor(brfss_1$self_reported_health, order=T,
levels = c("Good or Better","Fair or Poor"))

brfss_1 <- brfss_1 %>%
mutate(obese = ifelse(bmi >= 30, 1, 0),
exercise = ifelse(any_exercise_last_month == "No", 0, 1),
diabetes = ifelse(diabetes_status == "No", 0, 1),
heart_attack = ifelse(heart_attack_history == "No", 0, 1),
coronary = ifelse(coronary_hd_history == "No", 0, 1),
stroke = ifelse(stroke_history == "No", 0, 1),
self_health = ifelse(self_reported_health == "Fair or Poor", 0, 1))

str(brfss_1)

```
<br>

## EDA
<br> To assess relationships among numeric and binary predictors, we produced a **Spearman correlation matrix**. Spearman correlation is appropriate here because several variables are binary indicators and many relationships may be monotonic but not strictly linear. The correlation heatmap provides a quick check for potentially redundant predictors and highlights which health indicators tend to move together. <br>


```{r, message=FALSE, warning=FALSE}
brfss_nums = brfss_1[,c(5,10,19:25)]
str(brfss_nums)

spearman_corr <- cor(brfss_nums, use = "complete.obs", method = "spearman")
print(spearman_corr)

corrplot(spearman_corr, method = "color", type = "upper", tl.cex = 0.8)

```
<br>

## Modeling Approach

<br> We first modeled BMI as a continuous outcome to estimate how average BMI differs between people who were physically active vs not active. This establishes the baseline direction and magnitude of association between exercise and BMI.


```{r, message=FALSE, warning=FALSE}
fit1 <- lm(bmi ~ exercise, data = brfss_1)
summary(fit1)
xkabledply(fit1, title = paste("Model (factor):", format(formula(fit1)) ) )
xkablevif(fit1)
plot(fit1)


```
<br>
This model estimates the mean difference in BMI between the exercise groups. A statistically significant exercise coefficient would suggest that physically active adults have a different average BMI than inactive adults, but this model does not yet adjust for age or health status.
<br>

## Linear Regression with Covariates
<br>
To reduce confounding, we expanded the model to include age and self-reported health. This allows us to test whether the association between exercise and BMI persists after accounting for important demographic and health differences.
<br>

```{r, message=FALSE, warning=FALSE}
fit2 <- lm(bmi ~ exercise + age + self_health, data = brfss_1)
summary(fit2)
xkabledply(fit2, title = paste("Model (num):", format(formula(fit2)) ) )
xkablevif(fit2)
plot(fit2)


```
<br> Including covariates helps interpret the exercise coefficient as the estimated association with BMI while holding age and self-reported health constant. <br>

## Expanded Linear Model

<br> We further included additional health indicators such as diabetes and stroke history. This model assesses whether exercise remains associated with BMI even after controlling for comorbidity patterns that are strongly linked with weight status. <br>

```{r, message=FALSE, warning=FALSE}
fit3 <- lm(bmi ~ exercise + age + self_reported_health + diabetes + stroke, data = brfss_1)
summary(fit3)
xkablevif(fit3)
plot(fit3)

```
## Interaction Models
<br> Because the relationship between exercise and BMI may differ across health status groups, we tested interaction terms. Interaction models evaluate whether the effect of one predictor changes depending on another predictor (e.g., exercise effect differing across self-reported health categories). <br>

```{r, message=FALSE, warning=FALSE}
mixfit1 = lm(bmi ~ exercise + age + exercise:self_health, data = brfss_1)
summary(mixfit1)

mixfit2 <- lm(bmi ~ exercise + age + self_reported_health + diabetes * stroke, data = brfss_1)
summary(mixfit2)

```
<br> A significant interaction term would indicate that the association between predictors is not constant across groups (e.g., exercise relates differently to BMI for people with poor vs good health). <br>

## Association Tests Using Categories
## Chi-Squared Test: Physical Activity vs BMI Category

<br> To evaluate categorical relationships, we created a contingency table between physical activity and BMI category and performed a chi-squared test. This tests whether BMI category distributions differ between physically active and inactive groups. <br>


```{r, message=FALSE, warning=FALSE}

bmi_activitytable = xtabs(~ any_exercise_last_month + bmi_category, data = brfss_1)
bmi_activitytable

chisqactivity = chisq.test(bmi_activitytable)
chisqactivity

```
<br> A small p-value supports the conclusion that BMI category and physical activity are not independent, meaning exercise status is associated with BMI classification categories. <br>

## Chi-Squared Test: Self-Reported Health vs BMI Category

<br> We repeated the chi-squared procedure for self-reported health and BMI category to examine whether perceived health is related to BMI classification. <br>

```{r, message=FALSE, warning=FALSE}
bmi_selfhealthtable = xtabs(~ self_reported_health + bmi_category, data = brfss_1)
bmi_selfhealthtable

chisqselfhealth = chisq.test(bmi_selfhealthtable)
chisqselfhealth

```

## Chi-Squared Test: Self-Reported Health vs Overweight/Obese Indicator
<br> We also tested self-reported health against the overweight/obese indicator to examine whether perceived health differs across weight status. <br>

```{r, message=FALSE, warning=FALSE}
bmi_selfhealthtable2 = xtabs(~ self_reported_health + overweight_or_obese, data = brfss_1)
bmi_selfhealthtable2

chisqselfhealth2 = chisq.test(bmi_selfhealthtable2)
chisqselfhealth2


```

## Difference in Mean BMI by Physical Activity (Two-Sample t-Test)

<br> To directly compare mean BMI across physical activity groups, we conducted a two-sample t-test. This tests whether average BMI differs between adults who reported exercising in the last month versus those who did not. <br>

```{r, message=FALSE, warning=FALSE}
t.test(brfss_1$bmi ~ brfss_1$any_exercise_last_month)

mean_bmi = aggregate(bmi ~ any_exercise_last_month, data = brfss_1, FUN = mean)
mean_bmi

```
<br> A significant t-test indicates a meaningful difference in average BMI between exercise groups, and the group means provide the direction of that difference. <br>

## Logistic Regression & ROC/AUC (Classification View)
<br> In addition to modeling BMI directly, we used logistic regression to examine predictive ability in a classification setting. We first modeled physical activity status from BMI (and additional covariates), and evaluated performance using ROC curves and AUC values. <br>
```{r, message=FALSE, warning=FALSE}
activityLogit <- glm(any_exercise_last_month ~ bmi, data = brfss_1, family = "binomial")
summary(activityLogit)

prob = predict(activityLogit, type = "response")
brfss_1$prob = prob
h <- roc(any_exercise_last_month ~ prob, data = brfss_1)
auc(h)
plot(h)

activityLogit2 <- glm(any_exercise_last_month ~ bmi + age + self_reported_health, data = brfss_1, family = "binomial")
summary(activityLogit2)

prob2 = predict(activityLogit2, type = "response")
brfss_1$prob2 = prob2
i <- roc(any_exercise_last_month ~ prob2, data = brfss_1)
auc(i)
plot(i)

```
<br> ROC/AUC provides a threshold-independent measure of discrimination. AUC values closer to 1 indicate better separation, while values near 0.5 indicate weak discrimination. <br>

## Predicting Obesity (BMI ≥ 30) Using Exercise and Health Covariates

<br> To directly connect physical activity to obesity status, we fit logistic regression models predicting obesity from exercise and covariates. We evaluated performance using ROC/AUC and also computed McFadden’s pseudo-R² as a measure of explanatory strength. <br>

```{r, message=FALSE, warning=FALSE}
activityLogit3 <- glm(obese ~ exercise + age + self_health, data = brfss_1, family = "binomial")
summary(activityLogit3)

prob3 = predict(activityLogit3, type = "response")
brfss_1$prob3 = prob3
j <- roc(obese ~ prob3, data = brfss_1)
auc(j)
plot(j)

activityLogit3pr2 = pR2(activityLogit3)
activityLogit3pr2

```
<br> The sign and significance of the exercise coefficient indicate whether exercise is associated with lower odds of obesity after adjusting for age and self-reported health. AUC summarizes predictive discrimination, while McFadden’s pseudo-R² provides a model-fit comparison measure. <br>

## Best Subset Selection (bestglm)
<br> To explore whether a smaller set of predictors performs comparably, we applied exhaustive best subset selection using AIC to identify a parsimonious logistic model. <br>

```{r, message=FALSE, warning=FALSE}
library(bestglm)

# -------------------------------
# Model 1
# -------------------------------
brfss_3 <- brfss_1[, c(10, 19:25)]

# Convert all columns to numeric (required for bestglm)
brfss_3 <- data.frame(lapply(brfss_3, function(x) as.numeric(unlist(x))))

# Force binary response 0/1
brfss_3[, 1] <- ifelse(brfss_3[, 1] == 1, 1, 0)

# Remove missing values
brfss_3 <- na.omit(brfss_3)

res.bestglm1 <- bestglm(
  Xy = brfss_3,
  family = binomial,
  IC = "AIC",
  method = "exhaustive"
)

summary(res.bestglm1)
res.bestglm1$BestModels


# -------------------------------
# Model 2
# -------------------------------
brfss_2 <- brfss_1[, c(10, 5, 19:25)]

# Convert all columns to numeric
brfss_2 <- data.frame(lapply(brfss_2, function(x) as.numeric(unlist(x))))

# Force binary response 0/1
brfss_2[, 1] <- ifelse(brfss_2[, 1] == 1, 1, 0)

# Remove missing values
brfss_2 <- na.omit(brfss_2)

res.bestglm <- bestglm(
  Xy = brfss_2,
  family = binomial,
  IC = "AIC",
  method = "exhaustive"
)

summary(res.bestglm)
res.bestglm$BestModels



```

## Expanded Obesity Model + Confusion Matrix
<br> We also fit expanded logistic models including additional comorbidity indicators (diabetes, stroke, coronary disease, heart attack history). Model evaluation included ROC/AUC and confusion matrices to summarize classification behavior at a default threshold (0.5). <br>

```{r, message=FALSE, warning=FALSE}
activityLogit4 <- glm(obese ~ exercise + age + self_health + diabetes + stroke + heart_attack + coronary,
data = brfss_3, family = "binomial")
summary(activityLogit4)

prob4 = predict(activityLogit4, type = "response")
brfss_3$prob4 = prob4
k <- roc(obese ~ prob4, data = brfss_3)
auc(k)
plot(k)

activityLogit4pr2 = pR2(activityLogit4)
activityLogit4pr2

activityLogit5 <- glm(obese ~ exercise + age + self_health + diabetes + stroke + coronary,
data = brfss_3, family = "binomial")
summary(activityLogit5)

prob5 = predict(activityLogit5, type = "response")
brfss_3$prob5 = prob5
k <- roc(obese ~ prob5, data = brfss_3)
auc(k)
plot(k)

activityLogit5pr2 = pR2(activityLogit5)
activityLogit5pr2

library(ModelMetrics)
xkabledply(confusionMatrix(actual = activityLogit5$y, predicted = activityLogit5$fitted.values),
title = "Confusion matrix from Logit Model")

```
<br> The confusion matrix complements AUC by showing how predictions behave under a specific threshold. Together with pseudo-R², these outputs summarize both discrimination and overall explanatory strength. <br>

### Critical Limitations
BMI is self-reported in BRFSS, which can introduce measurement error and bias.

Physical activity is measured as a binary “any exercise last month” indicator, which does not capture intensity, frequency, or duration, limiting predictive power.

Models may be affected by omitted variables (diet quality, environment, access to recreation, and socioeconomic detail), and associations should not be interpreted as causal.

### Recommendations for Future Work
EReplace binary physical activity with richer measures (minutes per week or activity intensity) if available to better capture behavioral variation.

Include broader socioeconomic and behavioral covariates (income, race/ethnicity, alcohol use, smoking) to reduce confounding.

Test survey-weighted models (BRFSS sampling weights) for more accurate population-level inference.




# Question # 3
<br>
The COVID-19 pandemic introduced major disruptions to daily life, healthcare access, and emotional wellbeing. Because obesity is often associated with increased depression risk, we examine whether the **obesity–depression relationship changed after the onset of COVID-19** using **BRFSS 2018–2023**.

Research Question:

Did the relationship between obesity and depression change after the onset of COVID-19, controlling for key demographics (age group and sex)?
<br>

## Data Preparation & Variable Selection
<br>
We created binary indicators for the primary variables. Obesity status was recoded from `overweight_or_obese` into a numeric indicator where **0 = non-obese** and **1 = obese**. Depression history was recoded into a numeric indicator where **0 = no** and **1 = yes** using `depression_history`. To capture pandemic timing, we created a COVID period indicator where **pre-COVID = 0 (interview_year ≤ 2019)** and **post-COVID = 1 (interview_year ≥ 2020)**.

The final modeling dataset included depress, obese, covid_period, age_group, and sex, and missing values were removed prior to modeling.
<br>

```{r, message=FALSE, warning=FALSE}
library(tidyverse)

brfss <- readRDS("../Data/Processed/brfss_2018_2023.rds")

brfss$overweight_or_obese <- as.character(brfss$overweight_or_obese)

brfss <- brfss %>%
  mutate(
    obese = if_else(overweight_or_obese == "Yes", 1L, 0L),
    covid_period = if_else(interview_year <= 2019, 0L, 1L),
    depress = if_else(depression_history == "Yes", 1L, 0L)
  )

model_data <- brfss %>%
  dplyr::select(depress, obese, covid_period, age_group, sex) %>%
  tidyr::drop_na()
```

## Modeling Approach

<br> To test whether COVID changed the obesity–depression relationship, we fit a **logistic regression model** with an **interaction term** between obesity and COVID period:

depress∼obese∗covid_period+age_group+sex

The interaction term obese:covid_period evaluates whether the effect of obesity on depression differs between pre-COVID and post-COVID.


```{r, message=FALSE, warning=FALSE}
model_int_fixed <- glm(
depress ~ obese * covid_period + age_group + sex,
data   = model_data,
family = binomial()
)

summary(model_int_fixed)

```
<br>
# Odds Ratios (Pre-COVID vs Post-COVID)
<br> To make results interpretable, we computed **odds ratios (ORs)** for obesity separately in each COVID period. The **pre-COVID OR** uses only the obesity coefficient, while the **post-COVID OR** combines the obesity coefficient with the interaction term before exponentiating.
<br>

```{r, message=FALSE, warning=FALSE}
OR_pre <- exp(coef(model_int_fixed)["obese"])

OR_post <- exp(
coef(model_int_fixed)["obese"] +
coef(model_int_fixed)["obese:covid_period"]
)

OR_pre
OR_post

or_df <- data.frame(
Period = c("Pre-COVID", "Post-COVID"),
Odds_Ratio = c(as.numeric(OR_pre), as.numeric(OR_post))
)

ggplot(or_df, aes(x = Period, y = Odds_Ratio)) +
geom_bar(stat = "identity", fill = "orange") +
geom_hline(yintercept = 1, linetype = "dashed") +
labs(
title = "Change in Obesity–Depression Association Pre vs Post COVID",
x = "Period",
y = "Odds Ratio (Obese vs Non-obese)"
) +
theme_minimal()

```
<br> **Interpretation:** If the odds ratio is **greater than 1**, obese adults have higher odds of depression than non-obese adults. If `OR_post` is higher than `OR_pre`, the obesity–depression association strengthened after COVID began; if `OR_post` is lower, the association weakened slightly post-COVID. <br>

## Predicted Probability of Depression (Obesity × COVID Period)
<br> Odds ratios are helpful, but predicted probabilities are often easier to interpret. We estimated predicted depression probabilities for four groups: 1) Non-obese, Pre-COVID 2) Obese, Pre-COVID 3) Non-obese, Post-COVID 4) Obese, Post-COVID

To isolate obesity and COVID effects, predictions were generated holding age_group and sex constant at a reference level (the first factor level in the dataset).
<br>

```{r, message=FALSE, warning=FALSE}
pred_grid <- expand.grid(
obese = c(0, 1),
covid_period = c(0, 1),
age_group = levels(model_data$age_group)[1],
sex = levels(model_data$sex)[1]
)

pred_grid$pred_prob <- predict(
model_int_fixed,
newdata = pred_grid,
type = "response"
)

pred_grid <- pred_grid %>%
mutate(
Obesity_Status = if_else(obese == 1, "Obese", "Non-Obese"),
Period = if_else(covid_period == 1, "Post-COVID", "Pre-COVID")
)

ggplot(pred_grid, aes(x = Period, y = pred_prob, fill = Obesity_Status)) +
geom_bar(stat = "identity", position = "dodge") +
labs(
title = "Predicted Probability of Depression by Obesity and COVID Period",
x = "Period",
y = "Predicted Probability of Depression"
) +
theme_minimal()

```
<br>
**Interpretation:** If predicted depression probabilities rise in the post-COVID period for both obesity groups, that suggests overall depression risk increased after the pandemic. If the gap between obese and non-obese changes from pre to post, that indicates the relationship between obesity and depression shifted across periods.
<br>

### Predicted Probability with 95% Confidence Intervals
Predicted Probability with 95% Confidence Intervals
<br> To quantify uncertainty, we computed 95% confidence intervals around predicted probabilities using standard errors on the log-odds scale and transforming back to probability.
<br>

```{r, message=FALSE, warning=FALSE}
pred_probs <- predict(model_int_fixed, newdata = pred_grid, type = "link", se.fit = TRUE)

pred_grid$fit <- plogis(pred_probs$fit)
pred_grid$lwr <- plogis(pred_probs$fit - 1.96 * pred_probs$se.fit)
pred_grid$upr <- plogis(pred_probs$fit + 1.96 * pred_probs$se.fit)

ggplot(pred_grid, aes(x = Period, y = fit, color = Obesity_Status)) +
geom_point(size = 3) +
geom_errorbar(aes(ymin = lwr, ymax = upr), width = 0.1) +
geom_line(aes(group = Obesity_Status)) +
labs(
title = "Predicted Probability of Depression with 95% CI",
y = "Predicted Probability"
) +
theme_minimal()


```

### Critical Limitations
Self-Reported Outcome: Depression history is self-reported and may include reporting bias; it also does not measure severity.

Reference-Level Predictions: Predicted probabilities are computed at a fixed reference age_group and sex, so absolute probability values differ for other demographic profiles.

Omitted Variables: This model controls only for age group and sex; additional covariates (income, race/ethnicity, exercise, alcohol use, comorbidities) may further explain depression risk and change the estimated obesity effect.

### Recommendations for Future Work
Expanded Controls: Add socioeconomic and behavioral covariates to test robustness of the obesity effect.

Subgroup Analysis: Fit the model separately by sex or age_group to check for heterogeneous effects.

Survey Design Considerations: If survey weights are available in the BRFSS file, incorporate them to improve population-level inference.

# References

<br>
- Centers for Disease Control and Prevention. (2023). *BRFSS overview.* https://www.cdc.gov/brfss/annual_data/2023/pdf/Overview_2023-508.pdf  
- Centers for Disease Control and Prevention. (2021). *Behavioral Risk Factor Surveillance System comparability of data BRFSS 2020.* https://www.cdc.gov/brfss/annual_data/2020/pdf/compare-2020-508.pdf
<br><br><br>




